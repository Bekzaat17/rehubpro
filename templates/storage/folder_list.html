{% extends "base.html" %}
{% load static %}

{% block title %}–§–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ{% endblock %}

{% block content %}
<div class="container mt-4">

  {% if current_folder %}
    {% url 'storage:folder_detail' current_folder.id as folder_action_url %}
    {% url 'storage:file_actions' current_folder.id as file_action_url %}
  {% else %}
    {% url 'storage:root' as folder_action_url %}
    {% url 'storage:file_actions_root' as file_action_url %}
  {% endif %}

  <!-- üîò –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="btn-group">
      <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createFolderModal">üìÅ –ù–æ–≤–∞—è –ø–∞–ø–∫–∞</button>
      <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#uploadFileModal">‚¨Ü –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
    </div>

    <form method="get" class="d-flex">
      <input type="text" name="q" value="{{ query }}" class="form-control me-2" placeholder="üîç –ü–æ–∏—Å–∫...">
      <button class="btn btn-outline-secondary" type="submit">–ò—Å–∫–∞—Ç—å</button>
    </form>
  </div>

  <!-- üß≠ –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
  <div class="d-flex align-items-center justify-content-between mt-2 mb-3" style="min-height: 40px;">
    <!-- –ù–∞–∑–∞–¥ -->
    <div style="width: 90px;">
      {% if current_folder %}
        <a href="{% if current_folder.parent %}
                    {% url 'storage:folder_detail' current_folder.parent.id %}
                  {% else %}
                    {% url 'storage:root' %}
                  {% endif %}"
           class="btn btn-sm btn-outline-secondary">
          ‚¨Ö –ù–∞–∑–∞–¥
        </a>
      {% endif %}
    </div>

    <!-- –ü—É—Ç—å -->
    <nav aria-label="breadcrumb" class="flex-grow-1 ms-2">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item">
          <a href="{% url 'storage:root' %}">üè†</a>
        </li>
        {% if current_folder %}
          {% for ancestor in current_folder.get_ancestors %}
            <li class="breadcrumb-item">
              <a href="{% url 'storage:folder_detail' ancestor.id %}">{{ ancestor.name }}</a>
            </li>
          {% endfor %}
          <li class="breadcrumb-item active" aria-current="page">{{ current_folder.name }}</li>
        {% endif %}
      </ol>
    </nav>
  </div>

  <!-- üìã –¢–∞–±–ª–∏—Ü–∞ -->
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
          <th>–¢–∏–ø</th>
          <th>–†–∞–∑–º–µ—Ä</th>
          <th>–î–∞—Ç–∞</th>
          <th class="text-end">–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody>

        <!-- –ü–∞–ø–∫–∏ -->
        {% for folder in subfolders %}
          <tr>
            <td>
              üìÅ <a href="{% url 'storage:folder_detail' folder.id %}">{{ folder.name }}</a>
            </td>
            <td>–ü–∞–ø–∫–∞</td>
            <td>‚Äî</td>
            <td>{{ folder.created_at|date:"Y-m-d H:i" }}</td>
            <td class="text-end">
              <button type="button"
                      class="btn btn-sm btn-outline-secondary rename-btn"
                      data-id="{{ folder.id }}"
                      data-name="{{ folder.name }}"
                      data-url="{{ folder_action_url }}"
                      title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">
                ‚úè
              </button>
              <form method="post" action="{{ folder_action_url }}" class="d-inline ms-1">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="target_id" value="{{ folder.id }}">
                <button class="btn btn-sm btn-outline-danger" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>
              </form>
            </td>
          </tr>
        {% endfor %}

        <!-- –§–∞–π–ª—ã -->
        {% for file in files %}
          <tr>
            <td class="ps-4">üìÑ {{ file.name }}</td>
            <td>{{ file.get_readable_type }}</td>
            <td>{{ file.size_mb }} MB</td>
            <td>{{ file.uploaded_at|date:"Y-m-d H:i" }}</td>
            <td class="text-end">
              {% if file.is_previewable %}
                <a href="{{ file.file.url }}" target="_blank" class="btn btn-sm btn-outline-info" title="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">üëÅ</a>
              {% endif %}
              <a href="{{ file.file.url }}" class="btn btn-sm btn-outline-success ms-1" download title="–°–∫–∞—á–∞—Ç—å">‚¨á</a>
              <button type="button"
                      class="btn btn-sm btn-outline-secondary rename-btn ms-1"
                      data-id="{{ file.id }}"
                      data-name="{{ file.name }}"
                      data-url="{{ file_action_url }}"
                      title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">
                ‚úè
              </button>
              <form method="post" action="{{ file_action_url }}" class="d-inline ms-1">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="target_id" value="{{ file.id }}">
                <button class="btn btn-sm btn-outline-danger" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>
              </form>
            </td>
          </tr>
        {% endfor %}

        {% if not files and not subfolders %}
          <tr>
            <td colspan="5" class="text-center text-muted">–ó–¥–µ—Å—å –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç</td>
          </tr>
        {% endif %}

      </tbody>
    </table>
  </div>
</div>

<!-- üìÅ –ú–æ–¥–∞–ª–∫–∞: –ù–æ–≤–∞—è –ø–∞–ø–∫–∞ -->
<div class="modal fade" id="createFolderModal" tabindex="-1" aria-labelledby="createFolderLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{{ folder_action_url }}" class="modal-content">
      {% csrf_token %}
      <input type="hidden" name="action" value="create">
      <div class="modal-header">
        <h5 class="modal-title" id="createFolderLabel">–°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body">
        <input type="text" name="name" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏" required>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<!-- ‚¨ÜÔ∏è –ú–æ–¥–∞–ª–∫–∞: –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª -->
<div class="modal fade" id="uploadFileModal" tabindex="-1" aria-labelledby="uploadFileLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" enctype="multipart/form-data" action="{{ file_action_url }}" class="modal-content">
      {% csrf_token %}
      <input type="hidden" name="action" value="upload">
      <div class="modal-header">
        <h5 class="modal-title" id="uploadFileLabel">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body">
        <input type="file" name="file" class="form-control" required>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<!-- ‚úèÔ∏è –ú–æ–¥–∞–ª–∫–∞: –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ -->
<div class="modal fade" id="renameModal" tabindex="-1" aria-labelledby="renameModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" id="renameForm" class="modal-content">
      {% csrf_token %}
      <input type="hidden" name="action" value="rename">
      <input type="hidden" name="target_id" id="renameTargetId">

      <div class="modal-header">
        <h5 class="modal-title" id="renameModalLabel">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>

      <div class="modal-body">
        <input type="text" name="name" id="renameInput" class="form-control" required>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<!-- ‚öôÔ∏è JS –¥–ª—è –º–æ–¥–∞–ª–∫–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const renameButtons = document.querySelectorAll(".rename-btn");
    const renameForm = document.getElementById("renameForm");
    const renameInput = document.getElementById("renameInput");
    const renameTargetId = document.getElementById("renameTargetId");

    renameButtons.forEach((btn) => {
      btn.addEventListener("click", function () {
        const targetId = this.dataset.id;
        const currentName = this.dataset.name;
        const formAction = this.dataset.url;

        renameTargetId.value = targetId;
        renameInput.value = currentName;
        renameForm.action = formAction;

        const renameModal = new bootstrap.Modal(document.getElementById("renameModal"));
        renameModal.show();
      });
    });
  });
</script>
{% endblock %}