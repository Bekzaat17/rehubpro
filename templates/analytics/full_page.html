{% extends "base.html" %}
{% load static %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞{% endblock %}

{% block content %}
<div class="container mt-5">
  <h1 class="mb-4">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Ä–µ–∑–∏–¥–µ–Ω—Ç—É</h1>

  <form id="filter-form" class="row g-3 mb-4">
    <div class="col-md-4">
      <label for="resident" class="form-label">–†–µ–∑–∏–¥–µ–Ω—Ç</label>
      <select id="resident" name="resident_id" class="form-select">
        {% for resident in residents %}
          <option value="{{ resident.id }}">{{ resident.full_name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label for="date_from" class="form-label">–° –¥–∞—Ç—ã</label>
      <input type="date" id="date_from" name="date_from" class="form-control" />
    </div>
    <div class="col-md-3">
      <label for="date_to" class="form-label">–ü–æ –¥–∞—Ç—É</label>
      <input type="date" id="date_to" name="date_to" class="form-control" />
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">–ü–æ–∫–∞–∑–∞—Ç—å</button>
    </div>
  </form>

  <div class="text-end mb-3">
    <button id="export-button" class="btn btn-outline-secondary" disabled>üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
  </div>

  <div id="pdf-wrapper">
    <div id="pdf-header" class="text-center mb-4" style="display: none;">
      <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 1.5rem;">
        <img src="{% static 'logo/logo.png' %}" alt="–õ–æ–≥–æ—Ç–∏–ø" style="max-height: 160px; max-width: 100%;" />
      </div>
      <h2 class="mt-4" style="font-size: 2.2rem;">–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á—ë—Ç</h2>
      <p class="mt-3" style="font-size: 1.5rem;">–†–µ–∑–∏–¥–µ–Ω—Ç: <strong id="pdf-resident-name">‚Äî</strong></p>
      <p style="font-size: 1.3rem;">–ü–µ—Ä–∏–æ–¥: <span id="pdf-period">‚Äî</span></p>
    </div>

    <div id="analytics-results" class="row gy-4">
      <p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–∫–∞–∑–∞—Ç—å", —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É.</p>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  .analytics-block {
    max-width: 900px;
    margin: 0 auto;
    page-break-inside: avoid !important;
    break-inside: avoid !important;
  }

  .analytics-block:first-child {
    margin-top: 14px;
  }

  .chart-wrapper {
    position: relative;
    height: 350px;
    width: 100%;
  }

  @media (max-width: 768px) {
    .chart-wrapper {
      height: 300px;
    }
  }

  canvas {
    display: block;
    width: 100% !important;
    height: 100% !important;
  }

  .page-break {
    page-break-after: always;
    break-after: always;
  }

  .page-break-custom {
    page-break-before: always;
    break-before: always;
  }

  .timeline-clean {
    margin-top: 0.5rem;
    font-size: 0.9rem;
  }

  .timeline-clean-row {
    display: flex;
    flex-wrap: wrap;
    padding: 6px 10px;
    border-bottom: 1px dashed #dee2e6;
    background-color: #fff;
  }

  .timeline-clean-row:nth-child(even) {
    background-color: #f8f9fa;
  }

  .timeline-clean-row .timeline-date {
    min-width: 110px;
    font-weight: 600;
    color: #0d6efd;
    margin-right: 10px;
  }

  .timeline-clean-entry {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    line-height: 1.35;
    margin-bottom: 3px;
    flex: 1;
  }

  .timeline-task {
    font-weight: 600;
    color: #212529;
    min-width: 150px;
  }

  .timeline-stage {
    font-weight: 500;
    color: #6c757d;
    min-width: 100px;
  }

  .timeline-comment {
    font-style: italic;
    color: #6c757d;
    flex: 1;
    min-width: 150px;
  }

  .heatmap-row-separator tr:not(:last-child) td {
    border-bottom: 3px solid #dee2e6;
  }

  .heatmap-row-separator td,
  .heatmap-row-separator th {
    font-size: 0.85rem !important;
    font-weight: 400 !important;
    padding: 4px 6px !important;
    white-space: nowrap;
  }
</style>

<script src="{% static 'js/analytics/full_page.js' %}"></script>
{% endblock %}